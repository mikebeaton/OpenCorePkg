From 86217c0507a68ff2de27c29533226bc59b3ab61e Mon Sep 17 00:00:00 2001
From: ocbuild <ocbuild@acidanthera.local>
Date: Thu, 26 May 2022 22:47:44 +0100
Subject: [PATCH] VariableDxe new version

---
 .../Variable/RuntimeDxe/VariableDxe.c         | 61 ++++++++++++++++---
 1 file changed, 53 insertions(+), 8 deletions(-)

diff --git a/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c b/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c
index 03fec30..3adbde7 100644
--- a/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c
+++ b/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c
@@ -511,6 +511,42 @@ ProtocolIsVariablePolicyEnabled (
   return EFI_SUCCESS;
 }
 
+STATIC
+EFI_STATUS
+EFIAPI
+MapCreateEventEx (
+  IN       UINT32                 Type,
+  IN       EFI_TPL                NotifyTpl,
+  IN       EFI_EVENT_NOTIFY       NotifyFunction OPTIONAL,
+  IN CONST VOID                   *NotifyContext OPTIONAL,
+  IN CONST EFI_GUID               *EventGroup    OPTIONAL,
+  OUT      EFI_EVENT              *Event
+  )
+{
+  EFI_STATUS Status;
+
+  Status = EFI_UNSUPPORTED;
+  
+  if (Type == EVT_NOTIFY_SIGNAL) {
+    if (CompareGuid (EventGroup, &gEfiEventVirtualAddressChangeGuid)) {
+      Type = EVT_SIGNAL_VIRTUAL_ADDRESS_CHANGE;
+      Status = EFI_SUCCESS;
+    }
+  }
+
+  if (EFI_ERROR (Status)) {
+    return Status;
+  }
+
+  return gBS->CreateEvent (
+    Type,
+    NotifyTpl,
+    NotifyFunction,
+    (VOID *)NotifyContext,
+    Event
+  );
+}
+
 /**
   Variable Driver main entry point. The Variable driver places the 4 EFI
   runtime services in the EFI System Table and installs arch protocols
@@ -533,6 +569,7 @@ VariableServiceInitialize (
   EFI_STATUS  Status;
   EFI_EVENT   ReadyToBootEvent;
   EFI_EVENT   EndOfDxeEvent;
+  VOID        *OriginalCreateEventEx;
 
   Status = VariableCommonInitialize ();
   ASSERT_EFI_ERROR (Status);
@@ -587,6 +624,9 @@ VariableServiceInitialize (
     VariableWriteServiceInitializeDxe ();
   }
 
+  OriginalCreateEventEx = gBS->CreateEventEx;
+  gBS->CreateEventEx = MapCreateEventEx;
+
   Status = gBS->CreateEventEx (
                   EVT_NOTIFY_SIGNAL,
                   TPL_NOTIFY,
@@ -600,23 +640,23 @@ VariableServiceInitialize (
   //
   // Register the event handling function to reclaim variable for OS usage.
   //
-  Status = EfiCreateEventReadyToBootEx (
-             TPL_NOTIFY,
-             OnReadyToBoot,
-             NULL,
-             &ReadyToBootEvent
-             );
+  Status = gBS->CreateEvent (
+                  EVT_NOTIFY_SIGNAL,
+                  TPL_NOTIFY,
+                  OnReadyToBoot,
+                  NULL,
+                  &ReadyToBootEvent
+                  );
   ASSERT_EFI_ERROR (Status);
 
   //
   // Register the event handling function to set the End Of DXE flag.
   //
-  Status = gBS->CreateEventEx (
+  Status = gBS->CreateEvent (
                   EVT_NOTIFY_SIGNAL,
                   TPL_CALLBACK,
                   OnEndOfDxe,
                   NULL,
-                  &gEfiEndOfDxeEventGroupGuid,
                   &EndOfDxeEvent
                   );
   ASSERT_EFI_ERROR (Status);
@@ -634,5 +674,10 @@ VariableServiceInitialize (
                   );
   ASSERT_EFI_ERROR (Status);
 
+  gBS->CreateEventEx = OriginalCreateEventEx;
+
+  gBS->SignalEvent (EndOfDxeEvent);
+  gBS->SignalEvent (ReadyToBootEvent);
+
   return EFI_SUCCESS;
 }
-- 
2.31.1

