From a7b6398414129a648ec3f3d3aaaf8a448692b82c Mon Sep 17 00:00:00 2001
From: ocbuild <ocbuild@acidanthera.local>
Date: Wed, 25 May 2022 22:54:44 +0100
Subject: [PATCH] BruteForce

---
 .../Library/VariablePolicyLib/VariablePolicyLib.c      |  7 +++++++
 MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.c  |  8 ++++++++
 MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.h  |  8 ++++++++
 .../Universal/Variable/RuntimeDxe/VariableDxe.c        | 10 ++++++++++
 4 files changed, 33 insertions(+)

diff --git a/MdeModulePkg/Library/VariablePolicyLib/VariablePolicyLib.c b/MdeModulePkg/Library/VariablePolicyLib/VariablePolicyLib.c
index 82dae67..1a820f5 100644
--- a/MdeModulePkg/Library/VariablePolicyLib/VariablePolicyLib.c
+++ b/MdeModulePkg/Library/VariablePolicyLib/VariablePolicyLib.c
@@ -56,6 +56,11 @@ STATIC  UINT32  mCurrentTableCount = 0;
 #define MATCH_PRIORITY_MAX    MATCH_PRIORITY_EXACT
 #define MATCH_PRIORITY_MIN    MAX_UINT8
 
+VOID
+BruteForce (
+  VOID
+  );
+
 /**
   An extra init hook that enables the RuntimeDxe library instance to
   register VirtualAddress change callbacks. Among other things.
@@ -484,6 +489,8 @@ ValidateSetVariable (
   UINTN                              StateVarSize;
   UINT8                              StateVar;
 
+  //BruteForce ();
+  
   ReturnStatus = EFI_SUCCESS;
 
   if (!IsVariablePolicyLibInitialized ()) {
diff --git a/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.c b/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.c
index 6c1a344..3234fff 100644
--- a/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.c
+++ b/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.c
@@ -2442,6 +2442,8 @@ VariableServiceGetVariable (
   VARIABLE_POINTER_TRACK  Variable;
   UINTN                   VarDataSize;
 
+  //BruteForce ();
+
   if ((VariableName == NULL) || (VendorGuid == NULL) || (DataSize == NULL)) {
     return EFI_INVALID_PARAMETER;
   }
@@ -2533,6 +2535,8 @@ VariableServiceGetNextVariableName (
   VARIABLE_HEADER        *VariablePtr;
   VARIABLE_STORE_HEADER  *VariableStoreHeader[VariableStoreTypeMax];
 
+  //BruteForce ();
+
   if ((VariableNameSize == NULL) || (VariableName == NULL) || (VendorGuid == NULL)) {
     return EFI_INVALID_PARAMETER;
   }
@@ -2637,6 +2641,8 @@ VariableServiceSetVariable (
   UINTN                   PayloadSize;
   BOOLEAN                 AuthFormat;
 
+  //BruteForce ();
+
   AuthFormat = mVariableModuleGlobal->VariableGlobal.AuthFormat;
 
   //
@@ -3135,6 +3141,8 @@ VariableServiceQueryVariableInfo (
 {
   EFI_STATUS  Status;
 
+  //BruteForce ();
+
   if ((MaximumVariableStorageSize == NULL) || (RemainingVariableStorageSize == NULL) || (MaximumVariableSize == NULL) || (Attributes == 0)) {
     return EFI_INVALID_PARAMETER;
   }
diff --git a/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.h b/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.h
index 31e4089..8fd00db 100644
--- a/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.h
+++ b/MdeModulePkg/Universal/Variable/RuntimeDxe/Variable.h
@@ -254,6 +254,14 @@ UpdateVariable (
   IN      EFI_TIME                *TimeStamp  OPTIONAL
   );
 
+/**
+  Brute force.
+**/
+VOID
+BruteForce (
+  VOID
+  );
+
 /**
   Return TRUE if ExitBootServices () has been called.
 
diff --git a/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c b/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c
index c26800c..bb856ca 100644
--- a/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c
+++ b/MdeModulePkg/Universal/Variable/RuntimeDxe/VariableDxe.c
@@ -65,6 +65,16 @@ AtRuntime (
   return EfiAtRuntime ();
 }
 
+VOID
+BruteForce (
+  VOID
+  )
+{
+  if (AtRuntime ()) {
+    CpuDeadLoop ();
+  }
+}
+
 /**
   Initializes a basic mutual exclusion lock.
 
-- 
2.31.1

